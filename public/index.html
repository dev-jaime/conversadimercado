<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chatbot HF</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #343541;
    color: #d1d5db;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  h1 {
    text-align: center;
    padding: 1rem;
    color: #ffffff;
    margin: 0;
    background-color: #202123;
    box-shadow: 0 1px 5px rgba(0,0,0,0.3);
  }

  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    margin: 0.5rem;
    border-radius: 8px;
    background-color: #202123;
  }

  .message {
    margin-bottom: 1rem;
    line-height: 1.4;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .user { color: #9aedfe; }
  .bot { color: #ffffff; }

  #input-container {
    display: flex;
    padding: 0.5rem;
    background-color: #202123;
    margin: 0.5rem;
    border-radius: 8px;
  }

  #input {
    flex: 1;
    padding: 0.75rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    resize: none;
    min-height: 40px;
    max-height: 150px;
    overflow-y: auto;
    line-height: 1.4;
    background-color: #343541;
    color: #d1d5db;
    outline: none;
  }

  button {
    margin-left: 0.5rem;
    padding: 0.75rem 1rem;
    background-color: #10a37f;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
  }

  button:hover { background-color: #0e8c6d; }
</style>
</head>
<body onload="input.focus()">
<h1>Chatbot Hugging Face</h1>

<div id="chat"></div>

<div id="input-container">
  <textarea id="input" placeholder="Digite sua mensagem..." rows="1"></textarea>
  <button onclick="sendMessage()">Enviar</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");

// Ajuste automático de altura do textarea
input.addEventListener("input", () => {
  input.style.height = "auto";
  input.style.height = input.scrollHeight + "px";
});

// Enviar mensagem ao pressionar Enter (Shift+Enter para nova linha)
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault(); // evita quebra de linha
    sendMessage();
  }
});

function scrollChat() { chat.scrollTop = chat.scrollHeight; }

async function sendMessage() {
  const userMessage = input.value.trim();
  if(!userMessage) return;

  // Mensagem do usuário
  chat.innerHTML += `<div class="message user"><b>Você:</b> ${userMessage}</div>`;
  scrollChat();
  input.value = '';
  input.style.height = 'auto';

  // Mensagem do bot
  const botDiv = document.createElement("div");
  botDiv.className = "message bot";
  botDiv.innerHTML = `<b>Bot:</b> `;
  chat.appendChild(botDiv);
  scrollChat();

  try {
    const response = await fetch("https://spring-cake-1afc.jaime-mendes-ixia.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [{ role: "user", content: userMessage }],
        stream: true
      })
    });

    const data = await response.json();
    const reply = data?.choices?.[0]?.message?.content || "Sem resposta";

    
    // Simula streaming
    let i = 0;
    const interval = setInterval(() => {
      if (i < reply.length) {
        //botDiv.innerHTML += reply[i];
        // renderiza Markdown, incluindo tabelas
        botDiv.innerHTML += marked.parse(reply);
        i++;
        scrollChat();
      } else {
        clearInterval(interval);
      }
    }, 20);

  } catch(err) {
    botDiv.innerHTML += "Erro ao conectar ao modelo.";
  }
}
</script>
</body>
</html>